<!--
  ~ The contents of this file are subject to the OpenMRS Public License
  ~ Version 1.0 (the "License"); you may not use this file except in
  ~ compliance with the License. You may obtain a copy of the License at
  ~ http://license.openmrs.org
  ~
  ~ Software distributed under the License is distributed on an "AS IS"
  ~ basis, WITHOUT WARRANTY OF ANY KIND, either express or implied. See the
  ~ License for the specific language governing rights and limitations
  ~ under the License.
  ~
  ~ Copyright (C) OpenMRS, LLC.  All Rights Reserved.
-->
<htmlform>
    <script type="text/javascript">
        function populateDrugFields() {
            var captopril_obs_group = "<lookup expression="
            fn.latestObs(165253).obsId
            " />"

            var captopril_qsn_obs = "<lookup expression="
            fn.latestObs(1282).obsGroup.obsId
            " />"
            var captopril_qsn_obs_value = "<lookup expression="
            fn.latestObs(1282).valueCoded
            " />"

            var captopril_qsn_obs_coded = "<lookup expression="
            fn.latestObs(1282).valueCoded
            " />"
            var captopril_obs_numeric = "<lookup expression="
            fn.latestObs(1443).valueNuemric
            " />"
            var captopril_obs_coded = "<lookup expression="
            fn.latestObs(160855).valueCoded
            " />"

            if (captopril_qsn_obs == captopril_obs_group) {

                setValue('Captopril.value', captopril_qsn_obs_value);
            }

            setValue('captoprilDose.value', 90);
            setValue('captroprilFrequency.value', "Yes");
        }

        jq(document).ready(function () {
            populateDrugFields();
            jq('.hfe-hours').css('display', 'none');
            jq('.hfe-minutes').css('display', 'none');
            jq('.hfe-seconds').css('display', 'none');
        });

        function glucose() {
            var val = getValue('glucose.value');
            jq('#glucose-level :input').prop('disabled', true);
            if (val == 1065) {
                jq('#glucose-level :input').prop('disabled', false);
            }
        }

        function protein() {
            var val = getValue('protein.value');
            jq('#protein-level :input').prop('disabled', true);
            if (val == 1065) {
                jq('#protein-level :input').prop('disabled', false);
            }
        }

        function ketone() {
            var val = getValue('ketone.value');
            jq('#ketone-level :input').prop('disabled', true);
            if (val == 1065) {
                jq('#ketone-level :input').prop('disabled', false);
            }
        }

        function flagInputByRange(inputElementId, min, max) {
            var value = getValue(inputElementId + '.value');
            if (value &lt; min || value &gt; max) {
                jq('#' + inputElementId).last().addClass("red_flag");
            } else {
                jq('#' + inputElementId).last().removeClass("red_flag");
            }

        }

        function displayTabs() {
            var tabsObj = jq("#tabs").tabs();
            jQuery(".ui-tabs-panel").each(function (i) {

                var totalSize = jq(".ui-tabs-panel").size() - 1;
                var prevTag = '';
                var nextTag = '';
                if (i != totalSize) {
                    next = i + 2;
                    nextTag = '<div class="nav-button"><a href="#"  class="next" rel="' + next + '">Next Page &#187;</a></div>';

                    if (next == 2)
                        nextTag = '<div class="nav-button"><a href="#"   class="next" rel="' + next + '">Next Page &#187;</a></div>';
                }

                if (i != 0) {
                    prev = i;
                    prevTag = '<div class="nav-button"><a href="#" class="previous" rel="' + prev + '">&#171; Prev Page</a></div>';
                }


                if (prevTag) {
                    if (nextTag) jQuery(this).append('<div class="form-nav-container">' + prevTag + nextTag + '</div>');
                }

                if (prevTag) {
                    if (!nextTag) jQuery(this).append('<div class="form-nav-container">' + prevTag + '</div>');
                }

                if (nextTag) {
                    if (!prevTag) jQuery(this).append('<div class="form-nav-container">' + nextTag + '</div>');
                }


            });

            jQuery('.next, .previous').click(function () {
                tabsObj.tabs('select', jQuery(this).attr("rel"));
                return false;
            });

        }

        function onWeightOrHeightChange() {
            var display = '';
            var weightKg = parseFloat(getValue('weight.value'));
            var heightM = parseFloat(getValue('height.value')) / 100;
            numericValues('weight');
            numericValues('height');
            // validateWeightAndHeight();
            var displayDiv = 'calculated-bmi';
            if (!isNaN(weightKg) &amp;&amp; !isNaN(heightM)) {
                var bmi = weightKg / (heightM * heightM);
                if (isNaN(bmi) || bmi &lt; 10 || bmi &gt; 50) {
                    display = 'Abnormal value. Were weight and height entered correctly?';
                } else {
                    display = bmi.toFixed(2);
                    flagBMI(display, displayDiv);
                }
            }

            jq('#calculated-bmi').html(display);
        }

        function flagBMI(bmi, displayDiv) {
            var display = displayDiv;
            var normal_range_min = 18.50;
            var normal_range_max = 24.99;
            var overweight = 25.00;
            var obese = 30.00;
            jq('#' + display).last().removeClass("flag_green");
            jq('#' + display).last().removeClass("flag_yellow");
            jq('#' + display).last().removeClass("flag_red");

            if (bmi == obese || bmi &gt; obese) {
                jq('#' + display).last().addClass("flag_red");
                return;
            }

            if (bmi == overweight || bmi &gt; overweight) {
                jq('#' + display).last().addClass("flag_yellow");
                return;
            }

            if (bmi == normal_range_min || bmi &gt; normal_range_min) {
                jq('#' + display).last().addClass("flag_green");
                return;
            }

            if (bmi &lt; normal_range_min) {
                jq('#' + display).last().addClass("flag_red");
                return;
            }
        }

        function displayRecentBmi() {
            var weightKg = "<lookup expression="
            fn.latestObs(5089).valueNumeric
            "/>"
            var heightM = ("<lookup expression="
            fn.latestObs(5090).valueNumeric
            "/>"
        )/
            100
            var bmi = '';
            var displayDiv = 'recent-calculated-bmi';
            if (!isNaN(weightKg) &amp;&amp; !isNaN(heightM)) {
                bmi = weightKg / (heightM * heightM);
                flagBMI(bmi, displayDiv);
            }

            jq('#recent-calculated-bmi').html(bmi.toFixed(2));
        }

        function numericValues(id) {
            jq("#" + id).keydown(function (e) {
                // Allow: backspace, delete, tab, escape, enter and .
                if (jq.inArray(e.keyCode, [46, 8, 9, 27, 13, 110, 190]) !== -1 ||
                    // Allow: Ctrl/cmd+A
                    (e.keyCode == 65 &amp;&amp; (e.ctrlKey === true || e.metaKey === true)) ||
                    // Allow: Ctrl/cmd+C
                    (e.keyCode == 67 &amp;&amp; (e.ctrlKey === true || e.metaKey === true)) ||
                    // Allow: Ctrl/cmd+X
                    (e.keyCode == 88 &amp;&amp; (e.ctrlKey === true || e.metaKey === true)) ||
                    // Allow: home, end, left, right
                    (e.keyCode &gt; 34 &amp;&amp; e.keyCode &lt; 40)) {
                    // let it happen, don't do anything
                    return;
                }
                // Ensure that it is a number and stop the keypress
                if ((e.shiftKey || (e.keyCode &lt; 48 || e.keyCode &gt; 57)) &amp;&amp; (e.keyCode &lt; 96 || e.keyCode &gt; 105)) {
                    e.preventDefault();
                }
            });
        }

        function fillTreatmentSupportDetails() {

            var supporter_name = "<lookup expression="
            personAttributes.get('Treatment Supporter Name')
            "/>";
            var supporter_phone_number = "<lookup expression="
            personAttributes.get('Treatment Supporter Phone Number')
            "/>";
            var supporter_other_phone_number = "<lookup expression="
            personAttributes.get('Other Treatment Supporter Phone Number')
            "/>";
            var supporter_alternative_phone_number = "<lookup expression="
            personAttributes.get('Alternative Treatment Supporter Phone Number')
            "/>";

            setValue('supporter_name.value', supporter_name);
            setValue('supporter_phone_number.value', supporter_phone_number);
            setValue('supporter_other_phone_number.value', supporter_other_phone_number);
            setValue('supporter_alternative_phone_number.value', supporter_alternative_phone_number);

        }

        function flagWaistRatio(waistRatio) {

            var gender = "<lookup expression="
            patient.gender
            "/>";
            var maxMaleRatio = 0.9;
            var maxFemaleRatio = 0.85;

            jq('#hip_waist_ratio').last().removeClass("flagRed");

            if (gender == 'M' &amp;&amp; waistRatio &gt; maxMaleRatio) {
                jq('#hip_waist_ratio').last().addClass("flagRed");
                return;
            }

            if (gender == 'F' &amp;&amp; waistRatio &gt; maxFemaleRatio) {
                jq('#hip_waist_ratio').last().addClass("flagRed");
                return;
            }
        }

        function onHipOrWaistCircChange() {
            var display = '';
            var hip_circ = parseFloat(getValue('hip_circ.value'));
            var wcirc = parseFloat(getValue('wcirc.value'));
            numericValues('hip_circ');
            numericValues('wcirc');
            if (!isNaN(wcirc) &amp;&amp; !isNaN(hip_circ)) {
                var hipWaist = hip_circ / wcirc;
                if (isNaN(hipWaist)) {
                    display = '';
                } else {
                    display = hipWaist.toFixed(2);
                    flagWaistRatio(display);
                }
            }
            jq('#hip_waist_ratio').html(display);
        }

        function isValidPrescription(drug, value) {
            var weight = getValue('weight.value');
            var max = weight * drug.maxIuByKg;
            var min = weight * drug.minIuByKg;
            var nph = drug.name.includes('nph_type_1_');
            var obese = isObese();
            var nph = drug.name.includes('nph_type_1_');

            if (nph) {
                var nphGMin = 0.5 * weight;
                var nphGMax = 1 * weight;
                if (drug.obese == 1 &amp;&amp; obese == true) {
                    if (value &gt; max || value &lt; min) {
                        return drug.message;
                    }
                } else {
                    if (drug.obese == 2 &amp;&amp; obese == false) {
                        if (value &gt; max || value &lt; min) {
                            return drug.message;
                        }
                    }
                }

            }

            if (drug.maxIuByKg &gt; 0) {
                if (value &gt; max || value &lt; min) {
                    return drug.message;
                }
            } else {
                if (value &lt; min) {
                    return drug.message;
                }
            }

            return 1;
        }

        function invalidDrugPrescription() {

            var requiredFields = medLimitByCategory();
            var divHtml = "";

            var obese = isObese();

            divHtml = divHtml + checkDrug(requiredFields[0]);
            divHtml = divHtml + checkDrug(requiredFields[1]);

            if (obese == true) {
                divHtml = divHtml + checkDrug(requiredFields[2]);
            }

            if (obese == false) {
                divHtml = divHtml + checkDrug(requiredFields[3]);
            }
            divHtml = divHtml + checkDrug(requiredFields[4]);

            jq('#displayRequiredFields').html(divHtml);
            if (divHtml) {
                return true;
            }
            return false;

        }

        function isObese() {
            var weightKg = parseFloat(getValue('weight.value'));
            var heightM = parseFloat(getValue('height.value')) / 100;
            var bmi = weightKg / (heightM * heightM);
            var obese = 30.00;
            if (bmi == obese || bmi &gt; obese) {
                return true;
            }
            return false;
        }

        function limitedDoseChanges() {
            jq("#insulin_70_30, #insulin_70_30_frequency, #soluble_insulin, #soluble_insulin_frequency, #nph_type_1, #nph_type_1_frequency, #nph_type_2, #nph_type_2_frequency").change(invalidDrugPrescription);
        }

        function displayRecentDiabeticStatus() {
            var lastObs = "<lookup expression="
            fn.latestObs(165086).valueCoded
            "/>";

            var sectionId = 'diabetes_status';

            if (lastObs) {
                lastObs = lastObs.trim().split('#')[1];
                selectElementByValue(sectionId, lastObs);
            }

        }

        function displayRecentHTNStatus() {
            var lastObs = "<lookup expression="
            fn.latestObs(165091).valueCoded
            "/>"
            var sectionId = 'htn_status';
            if (lastObs) {
                lastObs = lastObs.trim().split('#')[1];
                selectElementByValue(sectionId, lastObs);
            }
        }

        function disableGDMFormMale() {
            var gender = "<lookup expression="
            patient.gender
            "/>";
            var sectionId = 'type_of_diabetes';

            if (gender == 'M') {
                disableElementByValue(sectionId, 1449);
                jq('#pdt :input').prop('disabled', true);
            }

        }

        function selectElementByValue(sectionId, value) {
            jq('#' + sectionId + ' :input').each(function () {
                var inputElement = jq(this);
                if (inputElement.val() == value) {
                    inputElement.prop("checked", true);
                }
            })
        }

        function disableElementByValue(sectionId, value) {
            jq('#' + sectionId + ' :input').each(function () {
                var inputElement = jq(this);
                if (inputElement.val() == value) {
                    inputElement.prop("disabled", true);
                }
            })
        }

        function setupDefaultValues() {
            var diabeticType = "<lookup expression="
            fn.latestObs(165094).valueCoded
            "/>";
            var hypertensionType = "<lookup expression="
            fn.latestObs(165198).valueCoded
            "/>";
            var hivStatus = "<lookup expression="
            fn.latestObs(138405).valueCoded
            "/>";
            var nhifStatus = "<lookup expression="
            fn.latestObs(1917).valueCoded
            "/>";
            var tbScreen = "<lookup expression="
            fn.latestObs(164800).valueCoded
            "/>";
            var tbStatus = "<lookup expression="
            fn.latestObs(165330).valueCoded
            "/>";

            if (diabeticType) {
                diabeticType = diabeticType.trim().split('#')[1];
                selectElementByValue('type_of_diabetes', diabeticType);
            }

            if (hypertensionType) {
                hypertensionType = hypertensionType.trim().split('#')[1];
                selectElementByValue('htn_type', hypertensionType);
            }
            if (hivStatus) {
                hivStatus = hivStatus.trim().split('#')[1];
                selectElementByValue('hiv_status', hivStatus);
            }
            if (nhifStatus) {
                nhifStatus = nhifStatus.trim().split('#')[1];
                selectElementByValue('nhif', nhifStatus);
            }
            if (tbScreen) {
                tbScreen = tbScreen.trim().split('#')[1];
                selectElementByValue('screened_for_tb', tbScreen);
            }
            if (tbStatus) {
                tbStatus = tbStatus.trim().split('#')[1];
                selectElementByValue('tb_status', tbStatus);
            }
        }


        jQuery(function () {
            displayTabs();
            getField('weight.value').change(onWeightOrHeightChange);
            getField('height.value').change(onWeightOrHeightChange);
            onWeightOrHeightChange();
            displayRecentBmi();
            fillTreatmentSupportDetails()
            jq('#wcirc').change(onHipOrWaistCircChange);
            jq('#hip_circ').change(onHipOrWaistCircChange);
            limitedDoseChanges();
            displayRecentDiabeticStatus();
            displayRecentHTNStatus();
            disableGDMFormMale();
            //setting values for some fields
            setupDefaultValues();
            jq('#glucose').change(glucose);
            jq('#protein').change(protein);
            jq('#ketone').change(ketone);

            jq('#sodium').change(function () {
                flagInputByRange('sodium', 135, 155);
            });
            jq('#chloride').change(function () {
                flagInputByRange('chloride', 98, 108);
            });
            jq('#potassium').change(function () {
                flagInputByRange('potassium', 3.5, 5.5);
            });
            jq('#urea').change(function () {
                flagInputByRange('urea', 2.70, 8.0);
            });


        });
    </script>

    <style>
        text-decoration: none

        ;
        display: inline-block

        ;
        padding:

        8
        px

        16
        px

        ;
        }

        .nav-button a:hover {
            background-color: #ddd;
            color: black;
        }

        .previous {
            background-color: #f1f1f1;
            font: bold 14px Arial;
            float: left;
        }

        .next {
            background-color: #ff7100;
            font: bold 14px Arial;
            float: right;
        }

        .form-nav-container {
            padding-top: 10px;
            padding-bottom: 10px;
            padding-left: 10px;
            padding-right: 10px;
            background-color: #00b4ef;
            height: 35px;
            margin-top: 5px;
            margin-bottom: 5px;

        }

        .nav-button a {
            padding-top: 10px;
            padding-left: 10px;
            padding-right: 10px;
            height: 25px;
            width: 10%;
        }

        .buttons-container {
            padding-bottom: 15px;
            padding-top: 5px;
        }

        .align-radio-input label {
            margin-top: -8px;
            padding-bottom: 5px;
            padding-top: 5px;
            margin-left: 10px;
        }

        .align-checkbox-input input {
            top: 10px;
            color: red;
        }

        .align-checkbox-input label

        ]
        {
            color: red
        ;
        }

        .green_flag input {
            color: green;
            font-weight: bold;
            font-size: 15px;
            padding-left: 10px;
            outline: 2px solid green;
        }

        .yellow_flag input {
            color: darkorange;
            font-weight: bold;
            font-size: 15px;
            padding-left: 10px;
            outline: 2px solid darkorange;
        }

        .red_flag input {
            color: red;
            font-weight: bold;
            font-size: 15px;
            padding-left: 10px;
            outline: 2px solid red;
        }

        .flag_green {
            color: green;
            font-weight: bold;
            font-size: 15px;
            padding-left: 10px;
        }

        .flag_yellow {
            color: darkorange;
            font-weight: bold;
            font-size: 15px;
            padding-left: 10px;
        }

        .flag_red {
            color: red;
            font-weight: bold;
            font-size: 15px;
            padding-left: 10px;
        }

        .comment_field {
            color: red;
        }

        .flagRed {
            color: red;
            font-weight: bold;
            font-size: 15px;
        }

    </style>
    <ifMode mode="ENTER">
        <includeIf velocityTest="$fn.allEncounters('edd8c072-18fb-11eb-9c05-839296c291c4').size() == 0">
            <script>
                jq(function () {
                    alert('This Patient has no initial , you will now be forwarded to the patient dashboard to fill initial form first');

                    var queryParameters = {}, queryString = location.search.substring(1),
                        re = /([^&amp;=]+)=([^&amp;]*)/g, m;

                    // Creates a map with the query string parameters
                    while (m = re.exec(queryString)) {
                        queryParameters[decodeURIComponent(m[1])] = decodeURIComponent(m[2]);
                    }
                    location.href = window.location.protocol + "//" + window.location.host +
                        '/' + OPENMRS_CONTEXT_PATH + '/ncdapp/ncdappSummary.page?patientId='
                        + queryParameters['patientId'];
                });
            </script>
        </includeIf>
    </ifMode>
    <div class="ke-form-header">
        <table style="width: 100%">
            <tr>
                <td align="left">Date:
                    <encounterDate id="encounter-date" showTime="true"/>
                </td>
                <td align="right">Location:
                    <encounterLocation default="GlobalProperty:kenyaemr.defaultLocation" type="autocomplete"/>
                </td>
            </tr>
        </table>
    </div>
    <div class="ke-form-content">
        <div id="tab-wrap">
            <div id="tabs">
                <ul>
                    <li><a href="#tabs-1">Page 1</a></li>
                    <li><a href="#tabs-2">Page 2</a></li>
                    <li><a href="#tabs-3">Page 3</a></li>
                    <li><a href="#tabs-4">Page 4</a></li>
                </ul>


                <div id="tabs-1">
                    <div class="ke-form-content">
                        <fieldset>
                            <legend>Encounter Details</legend>

                            <table border="0" cellpadding="0" cellspacing="0">
                                <tbody>
                                <tr>
                                    <td>
                                        Date:
                                        <encounterDate default="now" disallowMultipleEncountersOnDate="block"/>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                            <table>
                                <tbody>
                                <tr>
                                    <td valign="top">
                                        Treatment supporter's name:
                                        <obs conceptId="160638AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" id="supporter_name"/>
                                    </td>
                                    <td valign="top">
                                        Treatment Supporter's Cell phone Number:
                                        <obs conceptId="160642AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"
                                             id="supporter_phone_number"/>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                            <table>
                                <tbody>
                                <td>Visit Type:</td>
                                <td>
                                    <obs conceptId="164181AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"
                                         answerSeparator=""
                                         class="align-radio-input"
                                         answerConceptIds="163293AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA,160563AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA,1246AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA,160101AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"
                                         answerLabels="Sick,Referred,Scheduled,Unscheduled"/>
                                </td>
                                </tbody>
                            </table>

                        </fieldset>

                    <fieldset>
                        <legend>Clinical Notes</legend>
                        <table>
                            <tbody>
                                <tr>
                                    <td valign="top">
                                        <label>Chief complaint/Reason for encounter </label>
                                        <obs id="chief_complaint" conceptId="5219"
                                             answerConceptIds="110265AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA,130987AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA,141830AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA,112961AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA,135966AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA,135592AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA,147104AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA,6005AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA,164529AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA,5622AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"
                                             answerLabels="Shortness of breath on activity,
                                                Palpitations (heart racing),Recurrent dizziness,Fainting,Leg swelling,Loss of consciousness,Blurring of vision,Focal weakness,Foot complaints,Others"
                                             answerSeparator=""/>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <label>Specify other complains</label>
                                        <obs id="other_reasons_for_encounter" conceptId="5219" style="..."/>
                                    </td>
                                    <td>
                                        <label>Clinical notes </label>
                                        <obs conceptId="165106" answerConceptId="117460" answerLabel="High cholesterol"
                                             style="checkbox" class="align-checkbox-input" showCommentField="true"
                                             commentFieldLabel="&lt;/td&gt;&lt;td&gt;"/>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </fieldset>

                        <fieldset>
                            <legend>TB Screening</legend>


                        </fieldset>
                    </div>


                    <div id="displayRequiredFields"></div>
                    <div class="ke-form-footer">
                        <submit/>
                    </div>
                </div>
            </div>
        </div>
    </div>
</htmlform>